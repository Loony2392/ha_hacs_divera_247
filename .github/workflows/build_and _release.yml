name: CI Pipeline fÃ¼r Home Assistant Custom Component

on:
  push:
    branches: [main]
    # FÃ¼r automatisierte Releases: Trigger nur bei Tag-Pushes
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  ğŸ”_lint:
    name: Linting & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere Linting-Tools
        run: pip install flake8
      - name: FÃ¼hre Linting aus
        run: flake8 .

  âœ…_tests:
    name: Unit-Tests
    runs-on: ubuntu-latest
    needs: ğŸ”_lint
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere AbhÃ¤ngigkeiten und Test-Tools
        run: |
          pip install -r requirements.txt
          pip install pytest
      - name: FÃ¼hre Tests aus
        run: pytest

  ğŸ“Š_coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: âœ…_tests
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere AbhÃ¤ngigkeiten und Coverage-Tools
        run: |
          pip install -r requirements.txt
          pip install pytest coverage
      - name: FÃ¼hre Coverage aus
        run: |
          coverage run -m pytest
          coverage report -m

  ğŸš€_release:
    name: Release erstellen
    runs-on: ubuntu-latest
    needs: ğŸ“Š_coverage
    # Dieser Job wird nur ausgefÃ¼hrt, wenn ein Tag gepusht wird.
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Erstelle Distributionspakete
        run: python setup.py sdist bdist_wheel
      - name: Erstelle GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
