name: CI Pipeline für Home Assistant Custom Component

on:
  push:
    branches: [main]
    # Für automatisierte Releases: Trigger nur bei Tag-Pushes
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  🔍_lint:
    name: Linting & Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere Linting-Tools
        run: pip install flake8
      - name: Führe Linting aus
        run: flake8 .

  ✅_tests:
    name: Unit-Tests
    runs-on: ubuntu-latest
    needs: 🔍_lint
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere Abhängigkeiten und Test-Tools
        run: |
          pip install -r requirements.txt
          pip install pytest
      - name: Führe Tests aus
        run: pytest

  📊_coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: ✅_tests
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Installiere Abhängigkeiten und Coverage-Tools
        run: |
          pip install -r requirements.txt
          pip install pytest coverage
      - name: Führe Coverage aus
        run: |
          coverage run -m pytest
          coverage report -m

  🚀_release:
    name: Release erstellen
    runs-on: ubuntu-latest
    needs: 📊_coverage
    # Dieser Job wird nur ausgeführt, wenn ein Tag gepusht wird.
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Code Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Erstelle Distributionspakete
        run: python setup.py sdist bdist_wheel
      - name: Erstelle GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
